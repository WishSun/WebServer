# 服务器监听模块流程图  
![](https://i.imgur.com/0opbl73.png)  
  
## 注解：  
1. 调用配置文件解析模块解析IP地址和端口  

2. 创建线程池对象，线程池类采用的是单例模式，而且是创建即运行。所以创建后线程池对象后，工作线程就开始等待任务了。  

3. 进行socket、bind、listen一系列操作(服务器的标准流程)  

4. 将服务器监听套接字描述符第一个添加进epoll事件监听集合  

5. epoll_wait侦听事件发生后的四种情况处理: 

	- **5.1 新连接到来 :** 初始化新连接描述符对应的http_conn(http连接对象), 将套接字设置为非阻塞模式，并将其添加到epoll事件监听集合中，事件包括EPOLLIN | EPOLLRDHUP | EPOLLET(边沿触发模式) 

	- **5.2 客户端请求到来 ：** 客户端的请求，即get或post请求，交给请求分析模块去读取客户端请求，并分析。如果是一个无语法错误的请求(可以不完整), 则将该客户端连接对象加入线程池任务队列。
	- **5.3 客户端可写 ：**  
		* 设计上，是线程池那边解析好请求头之后，确认如果是POST请求，则将给客户端发送响应的任务交给CGI子进程去处理；如果是GET请求，则将请求的文件映射到内存上，然后由线程池发送响应头，然后设置描述符的EPOLLOUT事件，即将响应消息体的发送任务交给监听线程来处理。
		  
		* 当EPOLLOUT着个事件发生后，就去想客户端发送数据，也有可能消息体过大，数据没有一次性发完，造成TCP发送缓存满了，然后不能发送又得再次注册EPOLLOUT事件，此时EPOLLOUT被触发说明TCP缓存有空闲空间了，然后继续去发送数据。等到所有数据都发完了，则有重新开始监听EPOLLIN, 即检测客户端的下一次请求。
	
	- **5.4 异常情况 ：** : 所做的处理很简单，关闭出错的套接字描述符。
